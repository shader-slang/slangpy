name: slangpy_torch
on:
  workflow_dispatch:
    inputs:
      upload_to_pypi:
        description: 'Upload to PyPI? (0: no, 1: yes)'
        required: true
        default: '0'

jobs:
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: python -m pip install build twine

      - name: Build sdist
        working-directory: slangpy_torch
        run: python -m build --sdist

      - name: Verify sdist
        working-directory: slangpy_torch
        run: twine check --strict dist/*

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: slangpy_torch-sdist
          path: slangpy_torch/dist/*.tar.gz

  upload_pypi:
    name: Upload to PyPI
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.upload_to_pypi == '1' }}
    needs: [build_sdist]
    environment: pypi

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: slangpy_torch-sdist
          path: dist

      - name: Verify downloaded sdist
        run: |
          pip install twine
          echo "=== Checking sdist ==="
          for sdist in dist/*.tar.gz; do
            if [ -f "$sdist" ]; then
              size=$(stat -c%s "$sdist" 2>/dev/null || stat -f%z "$sdist" 2>/dev/null || echo "unknown")
              echo "Checking: $sdist (${size} bytes)"
              twine check --strict "$sdist"
            fi
          done

      - uses: pypa/gh-action-pypi-publish@v1.13.0
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
          verbose: true
