name: ci-latest-slang
run-name: "Slang ${{ github.event.inputs.slang_commit || format('branch: {0}', github.event.inputs.slang_branch || 'master') }}${{ github.event.inputs.test_iterations && format(' (bisect: {0}x)', github.event.inputs.test_iterations) || '' }}"

# ============================================================================
# BISECT MODE - FOR DEBUGGING INTERMITTENT CRASH (PR ONLY - DO NOT MERGE)
# ============================================================================
# How to use:
#   1. Push this branch to shader-slang/slangpy
#   2. Go to Actions → ci-latest-slang → Run workflow
#   3. Select this branch from the dropdown
#   4. Fill in:
#      - Slang commit SHA: e.g., 'abc123def456...'
#      - Test iterations: e.g., '10'
#   5. Click Run workflow
#   6. Check results and repeat with different commits
#
# When test_iterations is set:
#   - ONLY Linux jobs run (Windows/macOS skipped for speed)
#   - Runs the FULL test suite N times
#   - Exits immediately on first failure to preserve crash dumps
# ============================================================================

on:
  schedule:
    - cron: '0 1 * * *' # run at 1 AM UTC
  workflow_dispatch:
    inputs:
      slang_branch:
        description: 'Slang branch'
        required: true
        default: 'master'
      slang_commit:
        description: 'Slang commit SHA (for bisecting)'
        required: false
        default: ''
      test_iterations:
        description: 'Test iterations (e.g., 10 for bisect mode)'
        required: false
        default: ''

permissions:
  contents: read
  checks: write
  id-token: write

jobs:
  build:
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        os: [linux]
        config: [Debug, Release]
        python: ["3.10"]
        include:
          # Linux only - this is a bisect/debug branch
          - { os: linux, platform: x86_64, compiler: gcc, config: Debug, flags: "unit-test,crashpad", runs-on: { group: nvrgfx, labels: [Linux, X64] } }
          - { os: linux, platform: x86_64, compiler: gcc, config: Release, flags: "unit-test,test-examples,crashpad", runs-on: { group: nvrgfx, labels: [Linux, X64] } }

    env:
      # Environment variables used by ci.py
      CI_OS: ${{ matrix.os }}
      CI_PLATFORM: ${{ matrix.platform }}
      CI_COMPILER: ${{ matrix.compiler }}
      CI_CONFIG: ${{ matrix.config }}
      CI_PYTHON: ${{ matrix.python }}
      CI_FLAGS: ${{ matrix.flags }}

      # Path to the built slang compiler
      SLANG_PATH: ${{ github.workspace }}/slang/build/${{ matrix.config }}/bin

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Cleanup submodules # Fix for https://github.com/actions/checkout/issues/358
        run: |
          git submodule foreach --recursive git clean -ffdx
          git submodule foreach --recursive git reset --hard

      # Setup Linux.
      - name: Setup Linux
        if: startsWith(matrix.os, 'linux') && contains(matrix.runs-on, 'ubuntu-')
        run: |
          sudo apt update && sudo apt install -y libxinerama-dev libxcursor-dev xorg-dev libglu1-mesa-dev pkg-config

      # Setup Python.
      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      # Setup Python environment.
      - name: Setup Python environment
        run: |
          python -m pip install -r requirements-dev.txt
          python -m pip install -r samples/requirements.txt
          python -m pip install pytest-github-actions-annotate-failures

      # Setup PyTorch environment
      - name: Setup PyTorch environment
        if: runner.os != 'macos' && contains(matrix.flags, 'unit-test')
        run: |
          python -m pip install torch==2.8.0 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128

      # Setup MSVC.
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # Setup CMake/Ninja.
      - name: Setup CMake/Ninja
        uses: lukka/get-cmake@latest

      # Checkout Slang.
      - name: Checkout Slang
        run: |
          git clone --recursive https://github.com/shader-slang/slang.git
          cd slang
          COMMIT="${{ github.event.inputs.slang_commit || github.event.inputs.slang_branch || 'master' }}"
          git checkout "$COMMIT"
          git submodule update --init --recursive
          echo "========================================"
          echo "Slang commit: $(git rev-parse HEAD)"
          echo "Slang commit message: $(git log -1 --oneline)"
          echo "========================================"

      # Build Slang.
      - name: Build Slang
        run: |
          cd slang
          mkdir build
          cmake -B build --preset default
          cmake --build build --config ${{ matrix.config }} --parallel

      # Setup.
      - name: Setup
        run: python tools/ci.py setup

      # Setup vcpkg caching.
      # Only run on hosted runners.
      # For self-hosted runners, we use a local cache directory.
      - name: Set vcpkg cache directory
        if: startsWith(matrix.runs-on, 'ubuntu-') || startsWith(matrix.runs-on, 'macos-') || startsWith(matrix.runs-on, 'windows-')
        run: |
          echo "VCPKG_DEFAULT_BINARY_CACHE=${{ github.workspace }}/vcpkg-cache" >> $GITHUB_ENV
          mkdir -p ${{ github.workspace }}/vcpkg-cache
      - name: Setup vcpkg caching
        if: startsWith(matrix.runs-on, 'ubuntu-') || startsWith(matrix.runs-on, 'macos-') || startsWith(matrix.runs-on, 'windows-')
        uses: actions/cache@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-cache-${{ runner.os }}-${{ matrix.platform }}-${{ matrix.compiler }}-${{ hashFiles('vcpkg.json', 'external/vcpkg-triplets/**') }}

      # Configure.
      - name: Configure
        run: python tools/ci.py --cmake-args="-DSGL_LOCAL_SLANG=ON -DSGL_LOCAL_SLANG_DIR=slang -DSGL_LOCAL_SLANG_BUILD_DIR=build/${{ matrix.config }}" configure

      # Build.
      - name: Build
        run: python tools/ci.py build

      # Typing Checks (Python)
      - name: Typing Checks (Python)
        run: python tools/ci.py typing-check-python

      # Unit Tests (C++)
      - name: Unit Tests (C++)
        if: contains(matrix.flags, 'unit-test')
        run: python tools/ci.py unit-test-cpp

      # Unit Tests (Python)
      - name: Unit Tests (Python)
        if: contains(matrix.flags, 'unit-test') && github.event.inputs.test_iterations == ''
        run: python tools/ci.py unit-test-python --parallel

      # Unit Tests (Python) - Bisect Mode
      - name: Unit Tests (Python) - Bisect Mode
        if: contains(matrix.flags, 'unit-test') && github.event.inputs.test_iterations != ''
        shell: bash
        run: |
          ITERATIONS="${{ github.event.inputs.test_iterations }}"
          echo "=== BISECT MODE: Running full test suite ${ITERATIONS} times ==="
          echo "Will exit on first failure to preserve crash dumps"
          echo ""

          for i in $(seq 1 ${ITERATIONS}); do
            echo "======================================"
            echo "=== Iteration $i/${ITERATIONS} ==="
            echo "======================================"

            if ! python tools/ci.py unit-test-python --parallel; then
              echo ""
              echo "!!! Test suite FAILED on iteration $i/${ITERATIONS} !!!"
              echo "Crash dumps should be in .crashpad/reports/"
              exit 1
            fi

            echo "✓ Iteration $i passed"
            echo ""
          done

          echo ""
          echo "=========================================="
          echo "=== SUCCESS: All ${ITERATIONS} iterations passed ==="
          echo "=== No crash detected with this Slang commit ==="
          echo "=========================================="

      # Test Examples
      - name: Test Examples
        if: contains(matrix.flags, 'test-examples')
        run: python tools/ci.py test-examples -p

      # Upload Crashpad Reports
      - name: Upload Crashpad Reports
        if: always() && contains(matrix.flags, 'crashpad')
        uses: actions/upload-artifact@v4
        with:
          name: crash-reports-${{ matrix.os }}-${{ matrix.platform }}-${{ matrix.compiler }}-${{ matrix.config }}
          path: .crashpad/reports/
          if-no-files-found: ignore

      # Generate Coverage Report
      - name: Generate Coverage Report
        if: contains(matrix.flags, 'coverage')
        run: python tools/ci.py coverage-report

      # Coverage Report
      - name: Coverage Report
        uses: actions/upload-artifact@v4
        if: contains(matrix.flags, 'coverage')
        with:
          name: coverage-report
          path: reports/coverage.html

  # Notify Slack after all matrix jobs complete
  # DISABLED for bisect PR - do not send Slack messages
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: false  # Disabled for bisect PR
    steps:
      # Success Notification
      - name: Success Notification
        if: ${{ needs.build.result == 'success' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: ":green-check-mark: SlangPy nightly status: success\n"

      # Failure Notification
      - name: Failure Notification
        if: ${{ needs.build.result != 'success' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: ":alert: :alert: :alert: :alert: :alert: :alert:\nSlangPy nightly status: ${{ needs.build.result }}: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
